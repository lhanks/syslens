#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
UI_DIR="$PROJECT_ROOT/projects/ui"
BACKEND_DIR="$PROJECT_ROOT/projects/backend"

check_cargo() {
    if ! command -v cargo &> /dev/null; then
        echo "ERROR: Rust/Cargo not found."
        echo ""
        echo "Install Rust:"
        echo "  Windows: winget install Rustlang.Rustup"
        echo "  Or visit: https://rustup.rs"
        echo ""
        echo "After installing, restart your terminal and run this script again."
        exit 1
    fi
}

usage() {
    echo "Usage: $0 [ui|backend|all]"
    echo ""
    echo "Options:"
    echo "  ui       Run Angular tests only"
    echo "  backend  Run Rust tests only"
    echo "  all      Run all tests [default]"
    exit 1
}

MODE="${1:-all}"

run_ui_tests() {
    echo "Running Angular tests..."
    cd "$UI_DIR"
    npm test -- --watch=false
}

run_backend_tests() {
    check_cargo
    echo "Running Rust tests..."
    cd "$BACKEND_DIR"
    cargo test
}

case "$MODE" in
    ui)
        run_ui_tests
        ;;
    backend)
        run_backend_tests
        ;;
    all)
        run_ui_tests
        run_backend_tests
        echo "All tests complete!"
        ;;
    *)
        usage
        ;;
esac
