#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
UI_DIR="$PROJECT_ROOT/projects/ui"
BACKEND_DIR="$PROJECT_ROOT/projects/backend"

check_cargo() {
    if ! command -v cargo &> /dev/null; then
        echo "ERROR: Rust/Cargo not found."
        echo ""
        echo "Install Rust:"
        echo "  Windows: winget install Rustlang.Rustup"
        echo "  Or visit: https://rustup.rs"
        echo ""
        echo "After installing, restart your terminal and run this script again."
        exit 1
    fi
}

usage() {
    echo "Usage: $0 [ui|backend|all] [--fix]"
    echo ""
    echo "Options:"
    echo "  ui       Lint Angular code only"
    echo "  backend  Lint Rust code only"
    echo "  all      Lint all code [default]"
    echo "  --fix    Auto-fix issues where possible"
    exit 1
}

MODE="${1:-all}"
FIX=""

for arg in "$@"; do
    if [[ "$arg" == "--fix" ]]; then
        FIX="--fix"
    fi
done

lint_ui() {
    echo "Linting Angular code..."
    cd "$UI_DIR"
    if [[ -n "$FIX" ]]; then
        npm run lint -- --fix 2>/dev/null || npx ng lint --fix
    else
        npm run lint 2>/dev/null || npx ng lint
    fi
}

lint_backend() {
    check_cargo
    echo "Linting Rust code..."
    cd "$BACKEND_DIR"
    cargo fmt --check
    cargo clippy -- -D warnings
}

case "$MODE" in
    ui)
        lint_ui
        ;;
    backend)
        lint_backend
        ;;
    all)
        lint_ui
        lint_backend
        echo "Linting complete!"
        ;;
    --fix)
        # Handle case where --fix is first arg
        MODE="all"
        lint_ui
        lint_backend
        echo "Linting complete!"
        ;;
    *)
        usage
        ;;
esac
