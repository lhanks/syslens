#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
UI_DIR="$PROJECT_ROOT/projects/ui"
BACKEND_DIR="$PROJECT_ROOT/projects/backend"

check_cargo() {
    if ! command -v cargo &> /dev/null; then
        echo "ERROR: Rust/Cargo not found."
        echo ""
        echo "Install Rust:"
        echo "  Windows: winget install Rustlang.Rustup"
        echo "  Or visit: https://rustup.rs"
        echo ""
        echo "After installing, restart your terminal and run this script again."
        exit 1
    fi
}

usage() {
    echo "Usage: $0 [ui|backend|all]"
    echo ""
    echo "Options:"
    echo "  ui       Start Angular dev server only"
    echo "  backend  Start Tauri dev mode only"
    echo "  all      Start Tauri dev (includes UI) [default]"
    exit 1
}

MODE="${1:-all}"

case "$MODE" in
    ui)
        echo "Starting Angular dev server..."
        cd "$UI_DIR"
        [[ ! -d "node_modules" ]] && npm install
        npm start
        ;;
    backend)
        check_cargo
        echo "Starting Tauri dev mode..."
        cd "$BACKEND_DIR"
        cargo tauri dev
        ;;
    all)
        check_cargo
        echo "Starting Tauri dev mode (with Angular)..."
        cd "$BACKEND_DIR"
        cargo tauri dev
        ;;
    *)
        usage
        ;;
esac
